<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Tafelsalz  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset="utf-8">
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    
    <script src="js/lunr.min.js" defer></script>
    <script src="js/typeahead.jquery.js" defer></script>
    <script src="js/jazzy.search.js" defer></script>
  </head>
  <body>


    <a title="Tafelsalz  Reference"></a>

    <header class="header">
      <p class="header-col header-col--primary">
        <a class="header-link" href="index.html">
          Tafelsalz Docs
        </a>
         (100% documented)
      </p>
    
      <p class="header-col--secondary">
        <form role="search" action="search.json">
          <input type="text" placeholder="Search documentation" data-typeahead>
        </form>
      </p>
    
        <p class="header-col header-col--secondary">
          <a class="header-link" href="https://github.com/blochberger/Tafelsalz">
            <img class="header-icon" src="img/gh.png"/>
            View on GitHub
          </a>
        </p>
    
    </header>

    <p class="breadcrumbs">
      <a class="breadcrumb" href="index.html">Tafelsalz Reference</a>
      <img class="carat" src="img/carat.png" />
      Tafelsalz  Reference
    </p>

    <div class="content-wrapper">
      <nav class="navigation">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Classes.html">Classes</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/GenericHash.html">GenericHash</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/GenericHash/Key.html">– Key</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/KeyExchange.html">KeyExchange</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/KeyExchange/Side.html">– Side</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/KeyExchange/PublicKey.html">– PublicKey</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/KeyExchange/SessionKey.html">– SessionKey</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/KeyExchange/SessionKeyPair.html">– SessionKeyPair</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/KeyMaterial.html">KeyMaterial</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/MasterKey.html">MasterKey</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/MasterKey/Context.html">– Context</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/MasterKey/DerivedKey.html">– DerivedKey</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/Memory.html">Memory</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/Password.html">Password</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/Password/ComplexityLimit.html">– ComplexityLimit</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/Password/MemoryLimit.html">– MemoryLimit</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/Password/Salt.html">– Salt</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/Password/DerivedKey.html">– DerivedKey</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/Persona.html">Persona</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/Persona/Error.html">– Error</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/Persona/KeyType.html">– KeyType</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/SecretBox.html">SecretBox</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/SecretBox/SecretKey.html">– SecretKey</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/SecretBox/Nonce.html">– Nonce</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/SecretBox/AuthenticationCode.html">– AuthenticationCode</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/SecretBox/AuthenticatedCiphertext.html">– AuthenticatedCiphertext</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Global Variables.html">Global Variables</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Global Variables.html#/s:9Tafelsalz6sodiumAA6SodiumVvp">sodium</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Enums.html">Enumerations</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/Padding.html">Padding</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Extensions.html">Extensions</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/Array.html">Array</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/ArraySlice.html">ArraySlice</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/String.html">String</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Protocols.html">Protocols</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/EncryptedData.html">EncryptedData</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Structs.html">Structures</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/Blocks.html">Blocks</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/Ciphertext.html">Ciphertext</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/HashedPassword.html">HashedPassword</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/Random.html">Random</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/Sodium.html">Sodium</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/Sodium/SodiumGenericHash.html">– SodiumGenericHash</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/Sodium/SodiumKeyDerivation.html">– SodiumKeyDerivation</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/Sodium/SodiumKeyExchange.html">– SodiumKeyExchange</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/Sodium/SodiumMemory.html">– SodiumMemory</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/Sodium/SodiumPasswordHash.html">– SodiumPasswordHash</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/Sodium/SodiumRandom.html">– SodiumRandom</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/Sodium/SodiumSecretBox.html">– SodiumSecretBox</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Typealiases.html">Type Aliases</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Typealiases.html#/s:9Tafelsalz5Bytesa">Bytes</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">

        <section class="section">
          <div class="section-content">
            
            <h1 id='tafelsalz' class='heading'>Tafelsalz</h1>

<p><a href="https://travis-ci.org/blochberger/Tafelsalz"><img src="https://travis-ci.org/blochberger/Tafelsalz.svg?branch=master" alt="Build Status"></a> <a href="https://blochberger.github.io/Tafelsalz/macos/coverage/index.html"><img src="https://blochberger.github.io/Tafelsalz/macos/coverage.svg" alt="Coverage"></a> <a href="https://blochberger.github.io/Tafelsalz"><img src="https://blochberger.github.io/Tafelsalz/macos/public/badge.svg" alt="Documentation"></a></p>

<p>The main idea of this project is to provide usable but safe cryptographic operations.</p>

<p>The <a href="https://libsodium.org"><em>libsodium</em></a> project has a similar goal, but does not leverage the features available in modern programming languages such as Swift. The <em>libsodium</em> library is based on <a href="https://nacl.cr.yp.to">NaCl</a> whoose authors discussed the security issues related to cryptographic APIs that are too complicated and error-prone¹ – or as Matthew Green² put it:</p>

<blockquote>
<p>OpenSSL is the space shuttle of crypto libraries. It will get you to space, provided you have a team of people to push the ten thousand buttons required to do so. NaCl is more like an elevator — you just press a button and it takes you there. No frills or options.</p>

<p>I like elevators.</p>
</blockquote>

<p>To stay with the analogy: <em>libsodium</em> and <em>NaCl</em> prevent any accidents to happen if you press a button for some floor which isn&rsquo;t there. This project tries to prevent the button being there in the first place.</p>

<p>This is achieved by leveraging programming language features in a way that an operation cannot be called with invalid or insecure parameters. Every such call should be prevented at compile time already.</p>

<p>Note that the goal is not to prevent malicious attackers to circumvent the established protection mechanisms by the programming language features but to prevent accidental misuse of cryptographic APIs. If you want to learn more about cryptographic misuse, see our <a href="https://github.com/blochberger/Tafelsalz/wiki/References#cryptographic-misuse">literature collection on cryptographic misuse</a>.</p>

<ul>
<li>Repository: <a href="https://github.com/blochberger/Tafelsalz">https://github.com/blochberger/Tafelsalz</a></li>
<li>Documentation: <a href="https://blochberger.github.io/Tafelsalz">https://blochberger.github.io/Tafelsalz</a>

<ul>
<li>macOS: <a href="https://blochberger.github.io/Tafelsalz/macos/public">public</a>, <a href="https://blochberger.github.io/Tafelsalz/macos/internal">internal</a>, <a href="https://blochberger.github.io/Tafelsalz/macos/private">private</a></li>
<li>iOS: <a href="https://blochberger.github.io/Tafelsalz/iphone/public">public</a>, <a href="https://blochberger.github.io/Tafelsalz/iphone/internal">internal</a>, <a href="https://blochberger.github.io/Tafelsalz/iphone/private">private</a></li>
</ul></li>
<li>Issues: <a href="https://github.com/blochberger/Tafelsalz/issues">https://github.com/blochberger/Tafelsalz/issues</a></li>
</ul>

<p>Check out the project with:</p>
<pre class="highlight shell"><code>git clone <span class="nt">--recursive</span> https://github.com/blochberger/Tafelsalz.git
</code></pre>

<p>⚠️ <strong>WARNING</strong>: This project will not provide backwards compatibility. The API might change with the purpose of improving it. Changes should stabilize over time. If you need a more backwards compatible framework, I suggest to use <a href="https://github.com/jedisct1/swift-sodium">jedisct1/swift-sodium</a>.</p>

<p>If you simply want to play around with the API, you can try to solve the tasks of the <a href="https://github.com/AppPETs/DCrypt">DCrypt educational stub project</a>.</p>
<h2 id='concept' class='heading'>Concept</h2>

<p>There are several basic ideas:</p>

<ul>
<li>Let the compiler catch/enforce as much as possible.</li>
<li>Avoid common mistakes.</li>
<li>Combine convenience and security.</li>
<li>Take care of security-related stuff, that a cryptographic library usually does not, e.g., storing credentials securely on the device.</li>
</ul>

<p>Note that asymmetric encryption as well as stream encryption are not supported, yet (see <a href="https://github.com/blochberger/Tafelsalz/issues/2">https://github.com/blochberger/Tafelsalz/issues/2</a>, <a href="https://github.com/blochberger/Tafelsalz/issues/5">https://github.com/blochberger/Tafelsalz/issues/5</a>).</p>
<h2 id='features' class='heading'>Features</h2>
<h3 id='identity-management' class='heading'>Identity Management</h3>

<p>There are basically two different kinds of identities or actors: personas and contacts. For personas you are in posession of the secret keys. For contacts you are only in possession of the public keys.</p>

<p>Storing credentials is not as easy as it sounds. Many applications do this wrong and store a password for authenticating a user in plaintext or cryptographic keys alongside the encrypted data. Passwords for authenticating a user must not be stored directly, a salted hash should be stored instead, see <em>Password Hashing</em> below. For cryptographic keys it is better to use the credential storage offered by iOS, the <a href="https://developer.apple.com/documentation/security/keychain_services">Keychain services</a>. Credentials stored there are encrypted by the Secure Enclave³. Unfortunately the Keychain services are only accessible by a low-level API, with insufficient documentation by default. Convenience APIs for different tasks have been added.</p>

<p>Personas are app-specific: the bundle identifier of the application is used to distinguish two personas with the same unique name in two different applications. The secrets for personas are automatically generated when they are used for the first time. They are automatically stored in the system&rsquo;s Keychain. If a persona was created earlier, e.g., in a previous session, the keys will be automatically retrieved from the system&rsquo;s Keychain. A <code><a href="Classes/Persona.html">Persona</a></code> instance can be created with:</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">alice</span> <span class="o">=</span> <span class="kt">Persona</span><span class="p">(</span><span class="nv">uniqueName</span><span class="p">:</span> <span class="s">"Alice"</span><span class="p">)</span>
<span class="c1">// No secrets are generated until they are actually used.</span>
</code></pre>

<p>In order to remove all cryptographic keys of that persona, you can tell your application to forget it:</p>
<pre class="highlight swift"><code><span class="k">do</span> <span class="p">{</span>
    <span class="k">try</span> <span class="kt">Persona</span><span class="o">.</span><span class="nf">forget</span><span class="p">(</span><span class="n">alice</span><span class="p">)</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
    <span class="c1">// TODO Handle errors, which are either `Persona.Error` or `Keychain.Error`.</span>
<span class="p">}</span>
</code></pre>

<p>Note that by deleting a persona you will loose access to data encrypted for this persona.</p>
<h3 id='symmetric-encryption' class='heading'>Symmetric Encryption</h3>
<h4 id='ephemeral-keys' class='heading'>Ephemeral Keys</h4>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">secretBox</span> <span class="o">=</span> <span class="kt">SecretBox</span><span class="p">()</span>
<span class="k">let</span> <span class="nv">plaintext</span> <span class="o">=</span> <span class="s">"Hello, World!"</span><span class="o">.</span><span class="n">utf8Bytes</span>
<span class="k">let</span> <span class="nv">ciphertext</span> <span class="o">=</span> <span class="n">secretBox</span><span class="o">.</span><span class="nf">encrypt</span><span class="p">(</span><span class="nv">plaintext</span><span class="p">:</span> <span class="n">plaintext</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">decrypted</span> <span class="o">=</span> <span class="n">secretBox</span><span class="o">.</span><span class="nf">decrypt</span><span class="p">(</span><span class="nv">ciphertext</span><span class="p">:</span> <span class="n">ciphertext</span><span class="p">)</span><span class="o">!</span>
</code></pre>
<h4 id='persisted-keys' class='heading'>Persisted Keys</h4>

<p>The cryptographic keys in this example are stored within the system&rsquo;s  Keychain. See <em>Identity Management</em> for details.</p>
<pre class="highlight swift"><code><span class="c1">// Create a persona</span>
<span class="k">let</span> <span class="nv">alice</span> <span class="o">=</span> <span class="kt">Persona</span><span class="p">(</span><span class="nv">uniqueName</span><span class="p">:</span> <span class="s">"Alice"</span><span class="p">)</span>

<span class="c1">// Once a secret of that persona is used, it will be persisted in the</span>
<span class="c1">// system's Keychain.</span>
<span class="k">let</span> <span class="nv">secretBox</span> <span class="o">=</span> <span class="kt">SecretBox</span><span class="p">(</span><span class="nv">persona</span><span class="p">:</span> <span class="n">alice</span><span class="p">)</span><span class="o">!</span>

<span class="c1">// Use your SecretBox as usual</span>
<span class="k">let</span> <span class="nv">plaintext</span> <span class="o">=</span> <span class="s">"Hello, World!"</span><span class="o">.</span><span class="n">utf8Bytes</span>
<span class="k">let</span> <span class="nv">ciphertext</span> <span class="o">=</span> <span class="n">secretBox</span><span class="o">.</span><span class="nf">encrypt</span><span class="p">(</span><span class="nv">plaintext</span><span class="p">:</span> <span class="n">plaintext</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">decrypted</span> <span class="o">=</span> <span class="n">secretBox</span><span class="o">.</span><span class="nf">decrypt</span><span class="p">(</span><span class="nv">ciphertext</span><span class="p">:</span> <span class="n">ciphertext</span><span class="p">)</span><span class="o">!</span>
</code></pre>
<h4 id='padding' class='heading'>Padding</h4>

<p>Padding can be used to hide the length of the original message. The size of the ciphertext will be a multiple of the given block size.</p>

<p>Assume you have a client with a known set of possible configurations that are encrypted and stored on a server. If each configuration has a different size, then the server can distinguish the encrypted configurations based on their size. With padding all encrypted configurations can be made indistinguishable by chosing the block size in a way that all encrypted configurations have the same size, by using the size of the largest configuration as block size.</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">secretBox</span> <span class="o">=</span> <span class="kt">SecretBox</span><span class="p">()</span>
<span class="k">let</span> <span class="nv">plaintext</span> <span class="o">=</span> <span class="s">"Hello, World!"</span><span class="o">.</span><span class="n">utf8Bytes</span>
<span class="k">let</span> <span class="nv">padding</span><span class="p">:</span> <span class="kt">Padding</span> <span class="o">=</span> <span class="o">.</span><span class="nf">padded</span><span class="p">(</span><span class="nv">blockSize</span><span class="p">:</span> <span class="mi">16</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">ciphertext</span> <span class="o">=</span> <span class="n">secretBox</span><span class="o">.</span><span class="nf">encrypt</span><span class="p">(</span><span class="nv">plaintext</span><span class="p">:</span> <span class="n">plaintext</span><span class="p">,</span> <span class="nv">padding</span><span class="p">:</span> <span class="n">padding</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">decrypted</span> <span class="o">=</span> <span class="n">secretBox</span><span class="o">.</span><span class="nf">decrypt</span><span class="p">(</span><span class="nv">ciphertext</span><span class="p">:</span> <span class="n">ciphertext</span><span class="p">,</span> <span class="nv">padding</span><span class="p">:</span> <span class="n">padding</span><span class="p">)</span><span class="o">!</span>
</code></pre>
<h3 id='password-hashing' class='heading'>Password Hashing</h3>

<p>If the goal ist to simply authenticate the user, by validating if he knows a previously set password, then this should be used. The password must not be stored directly. A salted hash generated by a password hashing function should be stored instead. That way the actual password is kept secret even if the stored data can be accessed by unauthorized parties.</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">password</span> <span class="o">=</span> <span class="kt">Password</span><span class="p">(</span><span class="s">"Correct Horse Battery Staple"</span><span class="p">)</span><span class="o">!</span>
<span class="k">let</span> <span class="nv">hashedPassword</span> <span class="o">=</span> <span class="n">password</span><span class="o">.</span><span class="nf">hash</span><span class="p">()</span><span class="o">!</span>

<span class="c1">// Store `hashedPassword.string` to database.</span>

<span class="c1">// If a user wants to authenticate, just read it from the database and</span>
<span class="c1">// verify it against the password given by the user.</span>
<span class="k">if</span> <span class="n">hashedPassword</span><span class="o">.</span><span class="nf">isVerified</span><span class="p">(</span><span class="nv">by</span><span class="p">:</span> <span class="n">password</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// The user is authenticated successfully.</span>
<span class="p">}</span>
</code></pre>
<h3 id='generic-hashing' class='heading'>Generic Hashing</h3>
<h4 id='public-hashing' class='heading'>Public Hashing</h4>

<p>This can be used to create a hash value of a byte sequence that can be used for checking the byte sequences integrity or for proofing that a specific byte sequence is known, without disclosing the byte sequence. This must not be used for storing password hashes, use what is described in <em>Password Hashing</em> instead.</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="s">"Hello, World!"</span><span class="o">.</span><span class="n">utf8Bytes</span>
<span class="k">let</span> <span class="nv">hash</span> <span class="o">=</span> <span class="kt">GenericHash</span><span class="p">(</span><span class="nv">bytes</span><span class="p">:</span> <span class="n">data</span><span class="p">)</span>
</code></pre>
<h4 id='private-hashing-with-persisted-keys' class='heading'>Private Hashing with Persisted Keys</h4>

<p>Private hashing is similar to public hashing, but the hash value cannot be calculated by other parties.</p>
<pre class="highlight swift"><code><span class="c1">// Create a persona</span>
<span class="k">let</span> <span class="nv">alice</span> <span class="o">=</span> <span class="kt">Persona</span><span class="p">(</span><span class="nv">uniqueName</span><span class="p">:</span> <span class="s">"Alice"</span><span class="p">)</span>

<span class="c1">// Generate a personalized hash for that persona</span>
<span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="s">"Hello, World!"</span><span class="o">.</span><span class="n">utf8Bytes</span>
<span class="k">let</span> <span class="nv">hash</span> <span class="o">=</span> <span class="kt">GenericHash</span><span class="p">(</span><span class="nv">bytes</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="nv">for</span><span class="p">:</span> <span class="n">alice</span><span class="p">)</span>

<span class="c1">// Forget the persona and remove all related Keychain entries</span>
<span class="k">try!</span> <span class="kt">Persona</span><span class="o">.</span><span class="nf">forget</span><span class="p">(</span><span class="n">alice</span><span class="p">)</span>
</code></pre>
<h3 id='key-derivation' class='heading'>Key Derivation</h3>
<h4 id='master-key' class='heading'>Master Key</h4>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">context</span> <span class="o">=</span> <span class="kt">MasterKey</span><span class="o">.</span><span class="kt">Context</span><span class="p">(</span><span class="s">"Examples"</span><span class="p">)</span><span class="o">!</span>
<span class="k">let</span> <span class="nv">masterKey</span> <span class="o">=</span> <span class="kt">MasterKey</span><span class="p">()</span>
<span class="k">let</span> <span class="nv">subKey1</span> <span class="o">=</span> <span class="n">masterKey</span><span class="o">.</span><span class="nf">derive</span><span class="p">(</span><span class="nv">sizeInBytes</span><span class="p">:</span> <span class="kt">MasterKey</span><span class="o">.</span><span class="kt">DerivedKey</span><span class="o">.</span><span class="kt">MinimumSizeInBytes</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">and</span><span class="p">:</span> <span class="n">context</span><span class="p">)</span><span class="o">!</span>
<span class="k">let</span> <span class="nv">subKey2</span> <span class="o">=</span> <span class="n">masterKey</span><span class="o">.</span><span class="nf">derive</span><span class="p">(</span><span class="nv">sizeInBytes</span><span class="p">:</span> <span class="kt">MasterKey</span><span class="o">.</span><span class="kt">DerivedKey</span><span class="o">.</span><span class="kt">MinimumSizeInBytes</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">and</span><span class="p">:</span> <span class="n">context</span><span class="p">)</span><span class="o">!</span>

<span class="c1">// You can also derive a key in order to use it with secret boxes</span>
<span class="k">let</span> <span class="nv">secretBox</span> <span class="o">=</span> <span class="kt">SecretBox</span><span class="p">(</span><span class="nv">secretKey</span><span class="p">:</span> <span class="n">masterKey</span><span class="o">.</span><span class="nf">derive</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">and</span><span class="p">:</span> <span class="n">context</span><span class="p">))</span>
</code></pre>
<h4 id='password' class='heading'>Password</h4>

<p>This can be used to derive a cryptographic key from a given password. The API is still work-in-progress and needs to be simplified, see <a href="https://github.com/blochberger/Tafelsalz/issues/7">https://github.com/blochberger/Tafelsalz/issues/7</a>.</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">plaintext</span> <span class="o">=</span> <span class="s">"Hello, World!"</span><span class="o">.</span><span class="n">utf8Bytes</span>
<span class="k">let</span> <span class="nv">password</span> <span class="o">=</span> <span class="kt">Password</span><span class="p">(</span><span class="s">"Correct Horse Battery Staple"</span><span class="p">)</span><span class="o">!</span>

<span class="c1">// Derive a new key from a password</span>
<span class="k">let</span> <span class="nv">derivedKey1</span> <span class="o">=</span> <span class="n">password</span><span class="o">.</span><span class="nf">derive</span><span class="p">(</span><span class="nv">sizeInBytes</span><span class="p">:</span> <span class="kt">SecretBox</span><span class="o">.</span><span class="kt">SecretKey</span><span class="o">.</span><span class="kt">SizeInBytes</span><span class="p">)</span><span class="o">!</span>
<span class="k">let</span> <span class="nv">secretBox1</span> <span class="o">=</span> <span class="kt">SecretBox</span><span class="p">(</span><span class="nv">secretKey</span><span class="p">:</span> <span class="kt">SecretBox</span><span class="o">.</span><span class="kt">SecretKey</span><span class="p">(</span><span class="n">derivedKey1</span><span class="p">))</span>
<span class="k">let</span> <span class="nv">ciphertext</span> <span class="o">=</span> <span class="n">derivedKey1</span><span class="o">.</span><span class="n">publicParameters</span> <span class="o">+</span> <span class="n">secretBox1</span><span class="o">.</span><span class="nf">encrypt</span><span class="p">(</span><span class="nv">plaintext</span><span class="p">:</span> <span class="n">plaintext</span><span class="p">)</span><span class="o">.</span><span class="n">bytes</span>

<span class="c1">// Derive a previously generated key from a password</span>
<span class="k">let</span> <span class="p">(</span><span class="nv">salt</span><span class="p">,</span> <span class="nv">complexity</span><span class="p">,</span> <span class="nv">memory</span><span class="p">)</span> <span class="o">=</span> <span class="kt">Password</span><span class="o">.</span><span class="kt">DerivedKey</span><span class="o">.</span><span class="nf">extractPublicParameters</span><span class="p">(</span><span class="nv">bytes</span><span class="p">:</span> <span class="n">ciphertext</span><span class="p">)</span><span class="o">!</span>
<span class="k">let</span> <span class="nv">derivedKey2</span> <span class="o">=</span> <span class="n">password</span><span class="o">.</span><span class="nf">derive</span><span class="p">(</span><span class="nv">sizeInBytes</span><span class="p">:</span> <span class="kt">SecretBox</span><span class="o">.</span><span class="kt">SecretKey</span><span class="o">.</span><span class="kt">SizeInBytes</span><span class="p">,</span> <span class="nv">complexity</span><span class="p">:</span> <span class="n">complexity</span><span class="p">,</span> <span class="nv">memory</span><span class="p">:</span> <span class="n">memory</span><span class="p">,</span> <span class="nv">salt</span><span class="p">:</span> <span class="n">salt</span><span class="p">)</span><span class="o">!</span>
<span class="k">let</span> <span class="nv">secretBox2</span> <span class="o">=</span> <span class="kt">SecretBox</span><span class="p">(</span><span class="nv">secretKey</span><span class="p">:</span> <span class="kt">SecretBox</span><span class="o">.</span><span class="kt">SecretKey</span><span class="p">(</span><span class="n">derivedKey2</span><span class="p">))</span>
<span class="k">let</span> <span class="nv">authenticatedCiphertextBytes</span> <span class="o">=</span> <span class="kt">Bytes</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">[</span><span class="kt">Int</span><span class="p">(</span><span class="kt">Password</span><span class="o">.</span><span class="kt">DerivedKey</span><span class="o">.</span><span class="kt">SizeOfPublicParametersInBytes</span><span class="p">)</span><span class="o">...</span><span class="p">])</span>
<span class="k">let</span> <span class="nv">authenticatedCiphertext</span> <span class="o">=</span> <span class="kt">SecretBox</span><span class="o">.</span><span class="kt">AuthenticatedCiphertext</span><span class="p">(</span><span class="nv">bytes</span><span class="p">:</span> <span class="n">authenticatedCiphertextBytes</span><span class="p">)</span><span class="o">!</span>
<span class="k">let</span> <span class="nv">decrypted</span> <span class="o">=</span> <span class="n">secretBox2</span><span class="o">.</span><span class="nf">decrypt</span><span class="p">(</span><span class="nv">ciphertext</span><span class="p">:</span> <span class="n">authenticatedCiphertext</span><span class="p">)</span><span class="o">!</span>
</code></pre>
<h3 id='key-exchange' class='heading'>Key Exchange</h3>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">alice</span> <span class="o">=</span> <span class="kt">KeyExchange</span><span class="p">(</span><span class="nv">side</span><span class="p">:</span> <span class="o">.</span><span class="n">client</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">bob</span> <span class="o">=</span> <span class="kt">KeyExchange</span><span class="p">(</span><span class="nv">side</span><span class="p">:</span> <span class="o">.</span><span class="n">server</span><span class="p">)</span>

<span class="k">let</span> <span class="nv">alicesSessionKey</span> <span class="o">=</span> <span class="n">alice</span><span class="o">.</span><span class="nf">sessionKey</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">bob</span><span class="o">.</span><span class="n">publicKey</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">bobsSessionKey</span> <span class="o">=</span> <span class="n">bob</span><span class="o">.</span><span class="nf">sessionKey</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">alice</span><span class="o">.</span><span class="n">publicKey</span><span class="p">)</span>

<span class="c1">// alicesSessionKey == bobsSessionKey</span>
</code></pre>

<p>There is a demo application available for iOS, which shows how to exchange secrets between two devices with QR codes, using the key exchange mechanism, see <a href="https://github.com/AppPETs/SecretSharing-iOS">SecretSharing-iOS</a>.</p>

<hr>

<ol>
<li>D. J. Bernstein, T. Lange, and P. Schwabe, <a href="http://dx.doi.org/10.1007/978-3-642-33481-8_9"><strong>The Security Impact of a New Cryptographic Library</strong></a> in <em>Progress in Cryptology – LATINCRYPT 2012 – 2nd International Conference on Cryptology and Information Security in Latin America, Santiago, Chile, October 7-10, 2012. Proceedings</em> (A. Hevia and G. Neven, eds.), pp. 159–176</li>
<li>M. Green, <a href="http://blog.cryptographyengineering.com/2012/12/the-anatomy-of-bad-idea.html"><strong>The Anatomy of a Bad Idea</strong></a>, 2012</li>
<li>Apple Inc., <a href="https://www.apple.com/business/docs/iOS_Security_Guide.pdf"><strong>iOS Security – iOS 11</strong></a>, 2018</li>
</ol>

          </div>
        </section>


      </article>
    </div>
    <section class="footer">
      <p>&copy; 2019 <a class="link" href="https://github.com/blochberger" target="_blank" rel="external">Maximilian Blochberger</a>. All rights reserved. (Last updated: 2019-01-22)</p>
      <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy ♪♫ v0.9.4</a>, a <a class="link" href="https://realm.io" target="_blank" rel="external">Realm</a> project.</p>
    </section>
  </body>
</div>
</html>
